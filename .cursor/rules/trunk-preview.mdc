# Trunk + Preview Integration: Agent Rules

## Branches

- Always work off `main`. Name branches `feat/pi-<n>-<slug>`, `fix/pi-<n>-<slug>`, `chore/pi-<n>-<slug>`, `spike/pi-<n>-<slug>`.
- Keep PRs small (≤ ~400 LOC).

## PRs

- Target `main`. Use the PR template; link Charter & Log.
- Apply labels on PRs: `include-in-preview` and optionally `increment:pi-<n>`.

### Stacked PRs with Graphite

- Use Graphite (gt) for stacked PRs:
  - `gt create -m "feat(pi-<n>): <scope>"` to create focused PRs (100–400 LOC)
  - Keep PRs draft until green; merge bottom-up frequently
  - Top PR shows the cumulative diff for quick integration review
- Submission:
  - `gt submit --no-interactive` (drafts) and add labels via `gh pr edit <num> --add-label include-in-preview --add-label increment:pi-<n>`
- Restacking:
  - `gt restack` when `main` moves; fix conflicts at the lowest PR possible
- Charter/Log:
  - Update `docs/increments/pi-<n>/charter.md` status and append IL entries in each PR

## Preview

- Do not push directly to `preview/*`. Only automation updates preview branches.
- To compose the preview branch across many small PRs, run the GitHub workflow:
  - Terminal: `gh workflow run "Build Preview Integration Branch" -f increment=pi-3 -f include_label=include-in-preview`
  - Or use the Actions UI and set `increment=pi-3`.

## Exit

- After preview validation, squash-merge to `main`, then tag `pi-<n>.0.0`.

## Repo notes

- Required checks on `main`: `typecheck`, `lint`, `test:golden`, `test:schema`, `build`.
- Preview deploy is triggered by pushes to `preview/**`.

description: Trunk + Preview integration rules for branches, PRs, preview, and release tags
globs: [".github/workflows/**", ".github/**", "docs/**/*", "**/*.md", "**/*.mdc"]
alwaysApply: false

---
